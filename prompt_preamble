# Video Editor - Bug Fix Context

I'm experiencing a bug in the video editor's project-based workflow implementation.

## Tech Stack

- **Frontend**: React 18 + Vite (dev server on port 5173)
- **Backend**: FastAPI + Python (uvicorn on port 8000)
- **Database**: SQLite at `user_data/a/database.sqlite`
- **Video Processing**: FFmpeg (must be in PATH)

## Architecture Overview

The app uses a **project-based workflow** with three editing modes:

1. **Annotate Mode**: Mark clips in full game footage → Export to create raw clips + projects
2. **Framing Mode**: Edit clips (crop, speed, trim) → Export to create working video
3. **Overlay Mode**: Add highlight effects → Export to create final video in Gallery

**Navigation Flow**:
```
Project Manager → Select Project → Framing Mode
                                    ↓ (export)
                                  Overlay Mode
                                    ↓ (export)
                                  Gallery (Downloads)

OR: Annotate Game → Annotate Mode → Export → Creates projects → Back to Project Manager
```

## Key Backend Files

### API Routers
- `src/backend/app/routers/projects.py` - Project CRUD, state persistence
- `src/backend/app/routers/clips.py` - Raw clips library + working clips in projects
- `src/backend/app/routers/games.py` - Games storage, annotations, video upload
- `src/backend/app/routers/annotate.py` - Annotate export (creates clips + projects)
- `src/backend/app/routers/export.py` - Framing/overlay export with version tracking
- `src/backend/app/routers/downloads.py` - Gallery/downloads for final videos

### Core Services
- `src/backend/app/database.py` - DB schema, paths, initialization, migrations
- `src/backend/app/services/clip_cache.py` - Clip caching system (deduplicates work)

### Testing
- `test_persistence.py` - Comprehensive persistence tests (22 tests covering all versioning)
- `src/backend/tests/test_api.sh` - API integration tests
- `MANUAL_TEST.md` - Manual test procedures

## Key Frontend Files

### Main App
- `src/frontend/src/App.jsx` - Main app, mode switching, project state, persistence hooks

### Components
- `src/frontend/src/components/ProjectManager.jsx` - Project selection UI
- `src/frontend/src/components/ProjectHeader.jsx` - Project dropdown with Gallery button
- `src/frontend/src/components/ClipSelectorSidebar.jsx` - Clip list + add from library
- `src/frontend/src/components/ClipLibraryModal.jsx` - Browse raw clips library
- `src/frontend/src/components/DownloadsPanel.jsx` - Gallery slide-out panel
- `src/frontend/src/components/FileUpload.jsx` - Game video upload for Annotate mode
- `src/frontend/src/components/ProjectCreationSettings.jsx` - Annotate export settings
- `src/frontend/src/components/ExportButton.jsx` - Framing/overlay export
- `src/frontend/src/components/shared/ModeSwitcher.jsx` - Framing/Overlay mode tabs

### State Management Hooks
- `src/frontend/src/hooks/useProjects.js` - Projects list, CRUD operations
- `src/frontend/src/hooks/useProjectClips.js` - Working clips for selected project
- `src/frontend/src/hooks/useRawClips.js` - Raw clips library
- `src/frontend/src/hooks/useGames.js` - Games list, annotations, video upload
- `src/frontend/src/hooks/useDownloads.js` - Gallery/downloads state
- `src/frontend/src/hooks/useClipManager.js` - Client-side clip state
- `src/frontend/src/hooks/useSettings.js` - User settings persistence

### Annotate Mode
- `src/frontend/src/modes/annotate/AnnotateMode.jsx` - Main annotate component
- `src/frontend/src/modes/annotate/hooks/useAnnotate.js` - Clip regions, export
- `src/frontend/src/modes/annotate/components/AnnotateControls.jsx` - Playback controls
- `src/frontend/src/modes/annotate/components/ClipsSidePanel.jsx` - Clip list sidebar
- `src/frontend/src/modes/annotate/components/AnnotateFullscreenOverlay.jsx` - Fullscreen edit
- `src/frontend/src/modes/annotate/layers/ClipRegionLayer.jsx` - Timeline regions

## Database Schema (VERSION-BASED SYSTEM)

**CRITICAL**: This system uses INTEGER `version` columns, NOT boolean `abandoned` flags!

### Core Tables

```sql
-- Raw clips: Extracted from Annotate mode (4+ star ratings only)
CREATE TABLE raw_clips (
    id INTEGER PRIMARY KEY,
    filename TEXT NOT NULL,           -- Stored in user_data/a/raw_clips/
    rating INTEGER NOT NULL,          -- 1-5 stars (only 4+ saved)
    tags TEXT,                        -- Comma-separated tags
    name TEXT,                        -- Clip name from Annotate mode
    notes TEXT,                       -- Notes from Annotate mode
    start_time REAL,                  -- Original start time in source video
    end_time REAL,                    -- Original end time in source video (IDENTITY KEY)
    created_at TIMESTAMP
);

-- Projects: Organize clips for editing
CREATE TABLE projects (
    id INTEGER PRIMARY KEY,
    name TEXT NOT NULL,
    aspect_ratio TEXT NOT NULL,      -- '16:9', '9:16', '1:1'
    working_video_id INTEGER,        -- Latest working_videos.id (NULL if never exported)
    final_video_id INTEGER,          -- Latest final_videos.id (NULL if never exported)
    current_mode TEXT DEFAULT 'framing',  -- 'framing' or 'overlay' (for resume)
    last_opened_at TIMESTAMP,
    created_at TIMESTAMP
);

-- Working clips: Clips in projects with framing edits
CREATE TABLE working_clips (
    id INTEGER PRIMARY KEY,
    project_id INTEGER NOT NULL,
    raw_clip_id INTEGER,             -- NULL if uploaded directly (not from library)
    uploaded_filename TEXT,          -- Filename if uploaded directly
    progress INTEGER DEFAULT 0,      -- 0 = not exported, 1 = exported to working video
    sort_order INTEGER DEFAULT 0,    -- Display order in sidebar
    version INTEGER NOT NULL DEFAULT 1,  -- VERSION TRACKING (increments on re-export)
    crop_data TEXT,                  -- JSON: crop keyframes
    timing_data TEXT,                -- JSON: {trimRange}
    segments_data TEXT,              -- JSON: {boundaries, segmentSpeeds, trimRange}
    transform_data TEXT,             -- Reserved for future use
    created_at TIMESTAMP
);

-- Working videos: Output from Framing mode (intermediate rendered videos)
CREATE TABLE working_videos (
    id INTEGER PRIMARY KEY,
    project_id INTEGER NOT NULL,
    filename TEXT NOT NULL,          -- Stored in user_data/a/working_videos/
    version INTEGER NOT NULL DEFAULT 1,  -- VERSION TRACKING (increments per project)
    effect_type TEXT DEFAULT 'original', -- Overlay effect type
    highlights_data TEXT,            -- JSON: [{start_time, end_time, keyframes}]
    text_overlays TEXT,              -- JSON: [{text, timestamp, position}]
    duration REAL,
    created_at TIMESTAMP
);

-- Final videos: Output from Overlay mode (shown in Gallery)
CREATE TABLE final_videos (
    id INTEGER PRIMARY KEY,
    project_id INTEGER NOT NULL,
    filename TEXT NOT NULL,          -- Stored in user_data/a/final_videos/
    version INTEGER NOT NULL DEFAULT 1,  -- VERSION TRACKING (increments per project)
    duration REAL,
    created_at TIMESTAMP
);

-- Games: Full game footage for Annotate mode
CREATE TABLE games (
    id INTEGER PRIMARY KEY,
    name TEXT NOT NULL,
    video_filename TEXT,             -- NULL until upload completes (allows instant creation)
    annotations_filename TEXT,       -- TSV file with clip annotations
    video_duration REAL,             -- Cached metadata
    video_width INTEGER,
    video_height INTEGER,
    video_size INTEGER,
    created_at TIMESTAMP
);
```

## Version-Based Persistence System

**Key Concept**: The system uses INTEGER `version` numbers that increment on each export. Only the LATEST version is shown to users (except in Gallery which shows all versions).

### 1. Clip Versioning (IDENTITY BY END_TIME)

**Identity Rule**: Clips are identified by their `raw_clips.end_time` timestamp (NOT by ID).

- If two `working_clips` reference `raw_clips` with the SAME `end_time` → they are versions of each other
- Each re-export of a clip increments its version
- Example: User has 3 clips (all version 1). Re-exports one → that clip becomes version 2

**Window Function Pattern**:
```sql
-- Get latest working clips for a project
SELECT wc.* FROM working_clips wc
WHERE wc.id IN (
    SELECT id FROM (
        SELECT wc2.id, ROW_NUMBER() OVER (
            PARTITION BY COALESCE(rc2.end_time, wc2.uploaded_filename)
            ORDER BY wc2.version DESC
        ) as rn
        FROM working_clips wc2
        LEFT JOIN raw_clips rc2 ON wc2.raw_clip_id = rc2.id
        WHERE wc2.project_id = ?
    ) WHERE rn = 1
)
ORDER BY wc.sort_order;

-- Calculate next version for a clip (by end_time identity)
SELECT COALESCE(MAX(wc.version), 0) + 1 as next_version
FROM working_clips wc
JOIN raw_clips rc ON wc.raw_clip_id = rc.id
WHERE wc.project_id = ? AND rc.end_time = ?;
```

### 2. Working Video Versioning (PER PROJECT)

- Each framing export creates a new `working_videos` row with incremented version
- Only the latest version is used for Overlay mode
- `projects.working_video_id` points to the latest version ID

**Window Function Pattern**:
```sql
-- Get latest working video for a project
SELECT filename FROM working_videos
WHERE project_id = ?
ORDER BY version DESC LIMIT 1;

-- Calculate next version
SELECT COALESCE(MAX(version), 0) + 1 as next_version
FROM working_videos
WHERE project_id = ?;
```

### 3. Final Video Versioning (PER PROJECT)

- Each overlay export creates a new `final_videos` row with incremented version
- **ALL versions are shown in Gallery** (export history)
- `projects.final_video_id` points to the latest version ID

**Gallery Query** (shows only latest per project):
```sql
SELECT fv.* FROM final_videos fv
WHERE fv.id IN (
    SELECT id FROM (
        SELECT id, ROW_NUMBER() OVER (
            PARTITION BY project_id
            ORDER BY version DESC
        ) as rn
        FROM final_videos
    ) WHERE rn = 1
)
ORDER BY fv.created_at DESC;
```

## File Storage Paths

All files stored under `user_data/a/`:
- `database.sqlite` - SQLite database
- `raw_clips/` - Raw clip videos (from Annotate export)
- `uploads/` - Temporary uploaded files
- `games/` - Full game videos + annotation TSV files
- `working_videos/` - Intermediate rendered videos (framing output)
- `final_videos/` - Final rendered videos (overlay output)
- `downloads/` - Temporary export files (cleaned up after download)
- `clip_cache/` - Cached processed clips (deduplication)

## Expected Workflows

### Workflow 1: Annotate → Projects → Framing → Overlay → Gallery

1. **Start**: No project selected → Show Project Manager
2. **Annotate Game**: Click "Annotate Game" → Upload video
   - Video uploads in background (async, shows "Uploading..." while in progress)
   - UI immediately switches to Annotate mode
   - User marks clips on timeline (like highlight regions)
   - Export creates:
     - Raw clips (4+ star ratings) saved to `raw_clips` table + disk
     - Projects created (one game project + individual clip projects based on settings)
3. **Select Project**: Back to Project Manager → Select a project → Framing mode loads
4. **Framing Mode**:
   - Clips shown in sidebar (can add more from library)
   - Edit crop, speed, trim for each clip
   - Changes auto-save every 2 seconds (debounced) to `working_clips` columns
   - Export creates `working_videos` row (new version), marks clips `progress=1`
5. **Overlay Mode**:
   - Tab becomes enabled (requires working_video_id to be set)
   - Add highlight regions on timeline
   - Changes auto-save every 2 seconds to `working_videos.highlights_data`
   - Export creates `final_videos` row (new version)
6. **Gallery**: Click Gallery icon (with badge count) → View all final videos
   - Can play, download, or delete videos
   - Only shows latest version per project

### Workflow 2: Create Project → Add Clips from Library → Framing → Overlay

1. **Create Project**: Project Manager → "New Project" → Enter name, select aspect ratio
2. **Add Clips**: Framing mode → Sidebar "+" button → Browse library → Select clips
3. **Continue from step 4 above**

## Persistence & Auto-Save

### Framing Mode Auto-Save
- Triggers: Changes to crop keyframes, segments, or trim range
- Debounce: 2 seconds
- Target: `PUT /api/clips/projects/{project_id}/clips/{clip_id}`
- Data saved to `working_clips` columns: `crop_data`, `segments_data`, `timing_data`

### Overlay Mode Auto-Save
- Triggers: Changes to highlight regions or effect type
- Debounce: 2 seconds
- Target: `PUT /api/export/projects/{project_id}/working-video`
- Data saved to `working_videos` columns: `highlights_data`, `text_overlays`, `effect_type`

### Project State Auto-Save
- Triggers: Mode switch, project selection
- No debounce (immediate)
- Target: `PATCH /api/projects/{project_id}/state`
- Data saved to `projects` columns: `current_mode`, `last_opened_at`

## Clip Caching System

Located in `src/backend/app/services/clip_cache.py`:

- **Purpose**: Avoid re-rendering clips that haven't changed
- **Cache Key**: Hash of (video path, crop keyframes, segments, trim range)
- **Storage**: `user_data/a/clip_cache/` with metadata JSON
- **Reuse**: If cache hit, copy cached file instead of rendering
- **Benefits**: Faster exports when only some clips changed

## Recent Changes (Uncommitted - May Have Bugs)

### 1. Mode Switch Blocking with Confirmation Dialog

**Files Changed**:
- `src/frontend/src/components/shared/ConfirmationDialog.jsx` (NEW)
- `src/frontend/src/components/shared/index.js` - exports ConfirmationDialog
- `src/frontend/src/App.jsx` - mode switch dialog state and handlers

**Behavior**: When switching FROM Framing TO Overlay mode:
- If `overlayVideoUrl` exists (working video was exported) AND `framingChangedSinceExport` is true
- Show confirmation dialog with three options:
  - **Export First**: Stay in framing mode (user can export manually)
  - **Discard**: Call backend to delete uncommitted versions, reload clips, switch to overlay
  - **Cancel**: Close dialog, stay in framing

**Key Functions**:
- `handleModeChange()` - checks if dialog should be shown
- `handleModeSwitchDiscard()` - calls `discardUncommittedChanges()`, then `fetchClips()`
- `handleModeSwitchExport()` - closes dialog, stays in framing
- `handleModeSwitchCancel()` - closes dialog

### 2. Clip Versioning on Modification (Auto-Version)

**Files Changed**:
- `src/backend/app/routers/clips.py` - `update_working_clip()` function (lines 380-478)

**Behavior**: When saving framing edits via `PUT /api/clips/projects/{project_id}/clips/{clip_id}`:
- If clip has `progress >= 1` (was exported) AND update contains framing changes (`crop_data`, `timing_data`, or `segments_data`)
- Creates a NEW working_clips row with `version + 1` and `progress = 0`
- Copies all existing data from previous version
- Returns `{"success": true, "refresh_required": true}`
- Otherwise, updates clip in place, returns `{"success": true, "refresh_required": false}`

**API Response Pattern**: `refresh_required` tells client if it needs to fetch fresh data (server created new data).

### 3. Discard Uncommitted Changes Endpoint

**Files Changed**:
- `src/backend/app/routers/projects.py` - `discard_uncommitted_changes()` (lines 354-384)
- `src/frontend/src/hooks/useProjects.js` - `discardUncommittedChanges()` function

**Endpoint**: `POST /api/projects/{project_id}/discard-uncommitted`

**Behavior**: Deletes all working_clips where:
- `project_id` matches
- `progress = 0` (not exported)
- `version > 1` (is a newer version of an exported clip)

After deletion, the previous exported version (version 1, progress=1) becomes the "latest" again.

### 4. Progress Bar Enhancement

**Files Changed**:
- `src/backend/app/routers/projects.py` - `list_projects()`, `ProjectListItem` model (lines 35-47, 85-110)
- `src/frontend/src/components/ProjectManager.jsx` - `SegmentedProgressStrip` (lines 270-330)

**New API Fields in ProjectListItem**:
- `clips_exported` - Count of clips with `progress >= 1`
- `clips_in_progress` - Count of clips with `progress = 0` but have framing data
- `has_overlay_edits` - True if working_video has `highlights_data` or `text_overlays`

**Progress Bar States** (per segment):
- **Clip segments**: Green (exported), Blue (in_progress), Gray (pending)
- **Working video segment**: Green (exported), Gray (not exported)
- **Overlay segment**: Green (final exported), Blue (has edits), Light blue (working video exists), Gray (no working video)
- **Final segment**: Green (exported), Gray (not exported)

### 5. Auto-Save Prevention for Default State

**Files Changed**:
- `src/frontend/src/App.jsx` - `clipHasUserEditsRef` (line 94)

**Behavior**: Prevents auto-saving default/unchanged state as "user edits":
- `clipHasUserEditsRef` tracks if user made explicit edits to current clip
- Resets to `false` when clip selection changes
- Set to `true` in edit handlers (`handleCropComplete`, `handleKeyframeDelete`, `handleTrimSegment`, etc.)
- Auto-save only runs if `clipHasUserEditsRef.current === true` OR clip was loaded with saved data

### 6. Frontend Uses `refresh_required` Pattern

**Files Changed**:
- `src/frontend/src/hooks/useProjectClips.js` - `saveFramingEdits()` (lines 258-271)

**Behavior**: After saving framing edits:
- If `result.refresh_required === true`, calls `fetchClips()` to get fresh data
- Otherwise, updates local state with data that was just sent (no network call needed)

### Potential Bugs to Watch For

1. **Mode switch dialog not appearing** → Check `framingChangedSinceExport` state, `overlayVideoUrl` existence
2. **Discard not restoring previous version** → Verify `discard_uncommitted_changes()` SQL deletes correct clips (progress=0 AND version>1)
3. **Auto-version creating too many versions** → Check `is_framing_change` detection, `was_exported` check (progress >= 1)
4. **Progress bar showing wrong counts** → Check SQL window function for latest version filtering
5. **`refresh_required` not triggering refresh** → Check `saveFramingEdits()` handles response correctly
6. **Clip edits auto-saving when they shouldn't** → Check `clipHasUserEditsRef` is set correctly in edit handlers
7. **ConfirmationDialog not closing** → Check `setModeSwitchDialog({ isOpen: false, pendingMode: null })` calls

---

## Common Bug Patterns

### Project/UI State Issues
- **Project selection not updating UI** → Check `refreshSelectedProject()` calls after mutations
- **Overlay tab stays disabled** → Verify `working_video_id` is set AND file exists with latest version
- **Clips not appearing in sidebar** → Check window function query, `raw_clip_id` joins, `end_time` grouping
- **Progress stuck at 0%** → Check `calculate_progress()` uses latest-version window function

### Export/Rendering Issues
- **Export fails** → Check FFmpeg in PATH, file permissions, temp directory cleanup
- **Race condition on Annotate export** → Video upload must complete before export (check `isUploadingGameVideo` state)
- **Annotate export doesn't create projects** → Check rating filter (only 4+ stars saved)
- **Framing changes lost after refresh** → Check framing data saved to DB before export (use `saveCurrentClipState()`)

### Versioning Issues
- **Multiple clips showing instead of latest** → Check version filtering in window function
- **Clip versioning wrong** → Verify `end_time` identity logic (not `raw_clip_id`)
- **Overlay data not persisting** → Check auto-save to `working_videos` table (debounce timing)
- **Gallery not showing latest videos** → Check `final_videos` query with window function
- **Version numbers wrong** → Check `COALESCE(MAX(version), 0) + 1` calculation
- **Auto-version not triggering** → Check `is_framing_change` (crop_data, timing_data, OR segments_data) AND `was_exported` (progress >= 1)
- **Discard doesn't restore old version** → Verify DELETE WHERE `progress = 0 AND version > 1`

### Navigation/Flow Issues
- **Annotate export navigates away unexpectedly** → "Create Annotated Video" should stay, "Import to Projects" should navigate
- **Asterisk on Overlay tab appearing prematurely** → Check framing state snapshot comparison (`exportedFramingStateRef`)
- **Mode switch dialog not appearing** → Check `overlayVideoUrl && framingChangedSinceExport` condition in `handleModeChange()`
- **Mode switch dialog appearing when it shouldn't** → Check `framingChangedSinceExport` is correctly tracking changes vs exported state
- **Discard leaves stale UI state** → Check `loadProjectClips()` is called after `fetchClips()` in `handleModeSwitchDiscard()`
- **Video disappears when switching modes** → Check video reload logic uses correct clip ID (`workingClipId` not local `id`)

## Testing

### Manual Tests
See `MANUAL_TEST.md` for comprehensive UI testing procedures.

### Automated Tests
```bash
# Backend persistence tests (requires running server)
python test_persistence.py

# Expected: All 22 tests pass
# Tests cover: project state, clip versioning, working video versioning,
# final video versioning, overlay data persistence, version deletion
```

### API Tests
```bash
# Integration tests
bash src/backend/tests/test_api.sh
```