# Task 04: R2 Bucket Setup

## Overview
Configure the R2 bucket with proper CORS settings and folder structure for video storage.

## Owner
**User** - Requires Cloudflare dashboard access

## Prerequisites
- Task 01 complete (R2 bucket created)

## Time Estimate
15 minutes

---

## R2 Bucket Structure

```
reel-ballers-videos/
├── input/                    # Videos uploaded for processing
│   └── {job_id}/
│       └── video.mp4
├── output/                   # Processed videos ready for download
│   └── {job_id}/
│       └── video.mp4
└── temp/                     # Temporary files (auto-cleaned)
    └── {job_id}/
        └── ...
```

---

## CORS Configuration

### Via Cloudflare Dashboard

1. Go to **R2** → **reel-ballers-videos**
2. Click **Settings** tab
3. Scroll to **CORS Policy**
4. Click **Add CORS Policy**
5. Add this JSON:

```json
[
  {
    "AllowedOrigins": [
      "http://localhost:5173",
      "http://localhost:3000",
      "https://your-domain.com"
    ],
    "AllowedMethods": [
      "GET",
      "PUT",
      "POST",
      "DELETE",
      "HEAD"
    ],
    "AllowedHeaders": [
      "*"
    ],
    "ExposeHeaders": [
      "ETag",
      "Content-Length",
      "Content-Type"
    ],
    "MaxAgeSeconds": 3600
  }
]
```

### Via Wrangler CLI (Alternative)

Create `r2-cors.json`:
```json
{
  "cors_rules": [
    {
      "allowed_origins": ["http://localhost:5173", "http://localhost:3000"],
      "allowed_methods": ["GET", "PUT", "POST", "DELETE", "HEAD"],
      "allowed_headers": ["*"],
      "expose_headers": ["ETag", "Content-Length", "Content-Type"],
      "max_age_seconds": 3600
    }
  ]
}
```

Apply:
```bash
# Note: Wrangler CORS commands may require specific version
wrangler r2 bucket cors put reel-ballers-videos --config r2-cors.json
```

---

## Public Access Settings

**Keep bucket PRIVATE** - we'll use presigned URLs for access.

1. In R2 bucket settings, ensure **Public Access** is OFF
2. Videos are accessed via presigned URLs generated by Workers

---

## Lifecycle Rules (Optional)

Auto-delete temporary files after 24 hours:

1. Go to **R2** → **reel-ballers-videos** → **Settings**
2. Under **Object Lifecycle Rules**, add:

| Rule Name | Prefix | Action | Days |
|-----------|--------|--------|------|
| Clean temp | `temp/` | Delete | 1 |
| Clean old input | `input/` | Delete | 7 |

This prevents storage costs from accumulating.

---

## Testing R2 Access

### Via Workers (after Task 06)
```typescript
// Upload test
await env.VIDEOS.put('test/hello.txt', 'Hello R2!');

// Download test
const obj = await env.VIDEOS.get('test/hello.txt');
const text = await obj?.text();
console.log(text); // "Hello R2!"

// Delete test
await env.VIDEOS.delete('test/hello.txt');
```

### Via Wrangler CLI
```bash
# List bucket contents
wrangler r2 object list reel-ballers-videos

# Upload a test file
wrangler r2 object put reel-ballers-videos/test/hello.txt --file=./hello.txt

# Download
wrangler r2 object get reel-ballers-videos/test/hello.txt

# Delete
wrangler r2 object delete reel-ballers-videos/test/hello.txt
```

---

## Presigned URL Strategy

Workers will generate presigned URLs for:

### Upload (Frontend → R2)
```
POST /api/videos/upload-url
Request: { filename: "video.mp4", size: 1024000 }
Response: { upload_url: "https://...", video_key: "input/abc123/video.mp4" }
```

### Download (R2 → Frontend)
```
GET /api/jobs/{id}
Response includes: { output_url: "https://..." }  // Presigned, expires in 1 hour
```

This keeps the bucket private while allowing controlled access.

---

## Handoff Notes

**For Task 06 (Workers API Routes):**
- Bucket exists with CORS configured
- Use `env.VIDEOS` binding to access R2
- Generate presigned URLs for upload/download

**For Task 08 (GPU Worker):**
- GPU worker downloads from `input/{job_id}/`
- GPU worker uploads to `output/{job_id}/`
- Use R2's S3-compatible API with credentials

---

## R2 Credentials for RunPod

RunPod needs S3-compatible credentials to access R2:

1. Go to **R2** → **Manage R2 API Tokens**
2. Click **Create API Token**
3. Permissions: **Object Read & Write**
4. Specify bucket: `reel-ballers-videos`
5. Click **Create API Token**
6. **Save these values:**

```
Access Key ID: ________________________________
Secret Access Key: ________________________________
Endpoint: https://<account_id>.r2.cloudflarestorage.com
```

These will be used in Task 07 (RunPod setup) as environment variables.

---

## Cost Tracking

| Operation | Free Tier | Paid |
|-----------|-----------|------|
| Storage | 10GB | $0.015/GB/month |
| Class A (writes) | 1M/month | $4.50/million |
| Class B (reads) | 10M/month | $0.36/million |
| Egress | Unlimited | **Free!** |

**R2's killer feature**: No egress fees. Download as much as you want.
