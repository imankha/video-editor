# Task 04: R2 Bucket Setup

## Overview
Configure the R2 bucket to store ALL user data, mirroring the local `user_data/` folder structure exactly.

## Owner
**User** - Requires Cloudflare dashboard access

## Prerequisites
- Task 01 complete (R2 bucket created)

## Time Estimate
15 minutes

---

## R2 Bucket Structure

The bucket mirrors the local `user_data/` folder exactly:

```
reel-ballers-users/
└── {user_id}/                    # One "folder" per user (e.g., "a")
    ├── database.sqlite           # User's SQLite database
    ├── games/                    # Full game videos
    │   ├── 432b0e2bffba.mp4
    │   └── 6da56b059497.mp4
    ├── raw_clips/                # Extracted clips from games
    │   ├── 01db510ff166.mp4
    │   └── 02008bb31687.mp4
    ├── working_videos/           # Processed/cropped clips
    │   └── working_1_9db4ea07.mp4
    ├── final_videos/             # Exported final videos
    │   └── Great_Pass_final.mp4
    ├── highlights/               # Keyframe images for crop editing
    │   ├── clip_11_frame_28_kf0.png
    │   └── clip_11_frame_47_kf1.png
    ├── clip_cache/               # Temporary cached files
    ├── downloads/                # Downloaded files
    └── uploads/                  # User uploads
```

**Note**: R2 doesn't have real folders - these are just key prefixes. The structure is created automatically when you upload files with these paths.

---

## CORS Configuration

### Via Cloudflare Dashboard

1. Go to **R2** → **reel-ballers-users**
2. Click **Settings** tab
3. Scroll to **CORS Policy**
4. Click **Add CORS Policy**
5. Add this JSON:

```json
[
  {
    "AllowedOrigins": [
      "http://localhost:5173",
      "http://localhost:3000",
      "https://app.reelballers.com",
      "https://reelballers.com"
    ],
    "AllowedMethods": [
      "GET",
      "PUT",
      "POST",
      "DELETE",
      "HEAD"
    ],
    "AllowedHeaders": [
      "*"
    ],
    "ExposeHeaders": [
      "ETag",
      "Content-Length",
      "Content-Type"
    ],
    "MaxAgeSeconds": 3600
  }
]
```

### Via Wrangler CLI (Alternative)

Create `r2-cors.json`:
```json
{
  "cors_rules": [
    {
      "allowed_origins": ["http://localhost:5173", "http://localhost:3000"],
      "allowed_methods": ["GET", "PUT", "POST", "DELETE", "HEAD"],
      "allowed_headers": ["*"],
      "expose_headers": ["ETag", "Content-Length", "Content-Type"],
      "max_age_seconds": 3600
    }
  ]
}
```

Apply:
```bash
# Note: Wrangler CORS commands may require specific version
wrangler r2 bucket cors put reel-ballers-users --config r2-cors.json
```

---

## Public Access Settings

**Keep bucket PRIVATE** - we'll use presigned URLs for access.

1. In R2 bucket settings, ensure **Public Access** is OFF
2. Videos are accessed via presigned URLs generated by Workers

---

## Lifecycle Rules (Optional)

Auto-delete temporary/cached files:

1. Go to **R2** → **reel-ballers-users** → **Settings**
2. Under **Object Lifecycle Rules**, consider:

| Rule Name | Prefix Pattern | Action | Days |
|-----------|----------------|--------|------|
| Clean clip cache | `*/clip_cache/` | Delete | 1 |

**Note**: Be careful with lifecycle rules - most user data should be permanent. Only apply to truly temporary files.

---

## Testing R2 Access

### Via Workers (after Task 06)
```typescript
// Upload test
await env.USER_DATA.put('test/hello.txt', 'Hello R2!');

// Download test
const obj = await env.USER_DATA.get('test/hello.txt');
const text = await obj?.text();
console.log(text); // "Hello R2!"

// Delete test
await env.USER_DATA.delete('test/hello.txt');
```

### Via Wrangler CLI
```bash
# List bucket contents
wrangler r2 object list reel-ballers-users

# Upload a test file
wrangler r2 object put reel-ballers-users/test/hello.txt --file=./hello.txt

# Download
wrangler r2 object get reel-ballers-users/test/hello.txt

# Delete
wrangler r2 object delete reel-ballers-users/test/hello.txt
```

---

## Presigned URL Strategy

Workers will generate presigned URLs for:

### Upload (Frontend → R2)
```
POST /api/videos/upload-url
Request: { filename: "video.mp4", size: 1024000 }
Response: { upload_url: "https://...", video_key: "input/abc123/video.mp4" }
```

### Download (R2 → Frontend)
```
GET /api/jobs/{id}
Response includes: { output_url: "https://..." }  // Presigned, expires in 1 hour
```

This keeps the bucket private while allowing controlled access.

---

## Handoff Notes

**For Task 03 (R2 User Data Structure):**
- Bucket structure matches local `user_data/` exactly
- See Task 03 for detailed path conventions

**For Task 06 (Workers API Routes):**
- Bucket exists with CORS configured
- Use `env.USER_DATA` binding to access R2
- Generate presigned URLs for large file upload/download

**For Task 08 (GPU Worker):**
- GPU worker downloads from `{user_id}/raw_clips/` or `{user_id}/working_videos/`
- GPU worker uploads to `{user_id}/final_videos/`
- Use R2's S3-compatible API with credentials

---

## R2 Credentials for RunPod

RunPod needs S3-compatible credentials to access R2:

1. Go to **R2** → **Manage R2 API Tokens**
2. Click **Create API Token**
3. Permissions: **Object Read & Write**
4. Specify bucket: `reel-ballers-users`
5. Click **Create API Token**
6. **Save these values:**

```
Access Key ID: ________________________________
Secret Access Key: ________________________________
Endpoint: https://<account_id>.r2.cloudflarestorage.com
```

These will be used in Task 07 (RunPod setup) as environment variables.

---

## Cost Tracking

| Operation | Free Tier | Paid |
|-----------|-----------|------|
| Storage | 10GB | $0.015/GB/month |
| Class A (writes) | 1M/month | $4.50/million |
| Class B (reads) | 10M/month | $0.36/million |
| Egress | Unlimited | **Free!** |

**R2's killer feature**: No egress fees. Download as much as you want.
